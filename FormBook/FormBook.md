# Unpacking FormBook

| Malware Name | File Type | SHA256 |
| --- | ----------- | ----------- |
| FormBook | x32 exe | 9B11FA3CFA0ACDD01BE3595FBA22F7B38C333E7EC8DA88228C971735913BB6F7 |


## Analysis process

The initial file is a 32 bit Nullsoft installer (NSIS). right-clicking and unzipping will successfully extract the installer files.

![i](/FormBook/img/1.PNG)

I have read in some blog posts before that usually NSIS installers contain also an installer script, that was missing in that case.
Since the other two files apart from the DLL have unknown format and extension, I started to analyze the DLL.

![i](/FormBook/img/2.PNG)

This is a quite simple 32 bit DLL file that contains 2 exports. the first one was empty, I then decompiled the second one and performed some renaming and cleaning:

![i](/FormBook/img/3.PNG)

This function locates one of the other extracted files `hicclc.io` (that supposes to be dropped to `%TEMP%` by the NSIS installer by now), allocates some memory, copy the file content inside, and doing a simple xor loop with a hardcoded key to decode the next stage. then it simply calls that, which means that this is a shellcode.

I wrote a little python script to decode this stage:

```
i = 0
key = "584058684148"
decoded = b""

with open("hicclc.io", "rb") as f:
    encoded = f.read()

while i < 0x15e6:
    decoded_byte = encoded[i] ^ ord(key[i % 0xc])
    decoded += bytes([decoded_byte])
    i += 1
    
with open("shellcode.bin", "wb") as f:
    f.write(decoded)    
```

Here I used BlobRunner to debug the shellcode:

![i](/FormBook/img/4.PNG)

The shellcode mission is to load the 3'rd extracted file which is the 3'rd unpacking stage:

![i](/FormBook/img/5.PNG)

Following this flow carefully in the debugger:

![i](/FormBook/img/6.PNG)

Capturing `VirtualAlloc` return address to keep tracking of the decoded stage:

![i](/FormBook/img/7.PNG)

Then we can see how `ReadFile` is filling this memory with the file content:

![i](/FormBook/img/8.PNG)

Vwalla!

![i](/FormBook/img/9.PNG)

The following graph snippet contains a loop in the left block for decoding this stage. I located a BP on the completion of the loop in the right block and let run:

![i](/FormBook/img/10.PNG)

And now we love what we see!

Let's dump this PE to disk:

![i](/FormBook/img/11.PNG)

When keeping debug the shellcode we observe that it spawns another instance of itself:

![i](/FormBook/img/12.PNG)

![i](/FormBook/img/13.PNG)

Then it maps a fresh copy of NTDLL to evade EDR hooks in the original NTDLL:

![i](/FormBook/img/14.PNG)

Then it performs process hollowing by replacing the child process image with the PE we dumped before, some incriminating process hollowing calls are: 

![i](/FormBook/img/15.PNG)

![i](/FormBook/img/16.PNG)

![i](/FormBook/img/17.PNG)

Observing the final PE payload, reveals that it's highly obfuscated and difficult to analyze. It's written in pure assembly using MASM:

![i](/FormBook/img/18.PNG)

It contains only `.text` section, and Cutter really struggled to create the navigation bar above due to obfuscation and non-conventional code:

![i](/FormBook/img/19.PNG)

The final payload is really tough, and contains lots of anti-vm and anti-debugging tricks, that I won't cover today (or any other time :stuck_out_tongue_winking_eye:)

By using FLOSS, I managed to extract low-hanging fruits such as interesting stack strings, without delving too much into:

```
FLOSS extracted 180 stackstrings
DEST
version.dll
o%%Jr..\$
InternetCloseHandle
[System]
NT\CurrentVersion
encrypted_key
c!!B0
AAIA
:.6$
!H88p
POST
.exe
windir
.exe
Program Files
B>>|
[Enter]
image/jpeg
\DB1
Internet Explorer\IntelliForms\Storage2
Host:
URL:
HttpOpenRequestA
cl.ini
Password
ri.ini
PATH
Clipboard
pass
httpRealm
PATH
ProductName
User :
__Vault
XhHp
FBIMG
\INetCookies
windir
browser
Opera
Aut:
[v)C
" /V
\explorer.exe
G==z
11#?*0
cB@"
\Main
f""D~**T
[<-Del]
Pass:
login
P00`
WA      t
Windows Explorer
image/png
x86
7CbI
7A@@(
QSeA~
l$$H
im.jpeg
guid
Id:
Y77n
urlmon.dll
,4$8_@
rv.ini
U33f
InternetReadFile
[Esc]
InternetConnectA
auth
_2016\
AA&
ProgramFiles
2N H
FBNG:
i''N
hostname
profiles.ini
+Q0$
I<(A
=j&&LZ66lA??~
www.
g0+]C
)w--Z
Windows Explorer
_jbF~T
rg.ini
Chrome
im.jpeg
2008
ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
rc.ini
.dll
}++V
!tX)i
}{))R>
2012
ProgramFiles
x((Pz
x64
ACAA
USERNAME
t,,X.
`  @
gK99r
Pass:
='9-6d
_55j
AaAA
MS-WAPI-
CurrentVersion
t\lHBW
API-
Local State
2016
Iexplor
.sqlite
Server:
Unknown
D<<x
wininet.dll
aAAWindows Explorer
Name:
Outlook Recovery
V22dN::t
00.ini
Thunderbird\
\explorer.exe
AaAAt
\Cookies
Sniff from:
HttpSendRequestA
.zip
e##F^
\44h
M;;va
S11b?
\Opera Software\Opera Stable\Login Data
lpHP
aiKwZ
log.ini
user
\Microsoft\Windows
chrome_child.dll
open
\Low
200 OK
AaAA
Firefox\
.exe
User:
InternetOpenA
Firefox
Install Directory
Recovery
\Current Session
ProgramFiles
URL:
User-Agent:
Url:
hc 82
AEFA
@J7<
;fD4~
[Tab]
\Firefox
Port:
Host:
Unknown
.dll
User-Agent:
q//^
Firefox\
" /V
Unknown
NrZl
```

[The final payload](https://www.virustotal.com/gui/file/12077ad53e55f9c2878d1da0293d91afc1ea75571368844a4d8675ac8ca7ba58/detection) is waiting for reversers better than me :) 
